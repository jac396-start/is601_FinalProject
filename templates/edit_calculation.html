{% extends "layout.html" %}
{% block title %}Edit Calculation{% endblock %}

{% block content %}
<div class="container mt-4" id="edit-calculation" data-calc-id="{{ calc_id }}">
  <h2>Edit Calculation</h2>
  <p class="text-muted">Update operation type and inputs; preview recalculated result before saving.</p>

  <a class="btn btn-link" href="/dashboard">← Back to Dashboard</a>

  <div id="alert" class="alert d-none" role="alert"></div>

  <!-- Current data -->
  <div class="card mb-3">
    <div class="card-header">Current Calculation</div>
    <div class="card-body">
      <dl class="row mb-0">
        <dt class="col-sm-3">Type:</dt>
        <dd class="col-sm-9" id="current-type">Loading…</dd>

        <dt class="col-sm-3">Inputs:</dt>
        <dd class="col-sm-9" id="current-inputs">Loading…</dd>

        <dt class="col-sm-3">Result:</dt>
        <dd class="col-sm-9" id="current-result">Loading…</dd>
      </dl>
    </div>
  </div>

  <!-- Edit form -->
  <form id="edit-form" class="card">
    <div class="card-header">Edit</div>
    <div class="card-body">
      <div class="mb-3">
        <label for="operation" class="form-label">Operation Type *</nlabel>
        <select id="operation" name="type" class="form-select" required>
          <option value="addition">Addition</option>
          <option value="subtraction">Subtraction</option>
          <option value="multiplication">Multiplication</option>
          <option value="division">Division</option>
        </select>
        <div class="form-text">Changing the operation type will re-calculate the result.</div>
      </div>

      <div class="mb-3">
        <label for="numbers" class="form-label">Numbers (comma-separated) *</label>
        <input id="numbers" name="inputs" type="text" class="form-control" placeholder="e.g. 12, 3, 2" required />
        <div class="form-text">Enter at least two numbers separated by commas.</div>
      </div>

      <!-- Preview -->
      <div class="border rounded p-3 bg-light">
        <h6 class="mb-2">Preview</h6>
        <div><strong>New calculation:</strong> <span id="preview-expression">—</span></div>
        <div><strong>Estimated result:</strong> <span id="preview-result">—</span></div>
      </div>
    </div>
    <div class="card-footer d-flex gap-2">
      <button type="submit" class="btn btn-primary" id="save-btn">Save Changes</button>
      <a class="btn btn-outline-secondary" href="/dashboard">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const root = document.getElementById('edit-calculation');
  const calcId = root?.dataset?.calcId;
  const currentTypeEl = document.getElementById('current-type');
  const currentInputsEl = document.getElementById('current-inputs');
  const currentResultEl = document.getElementById('current-result');
  const operationEl = document.getElementById('operation');
  const numbersEl = document.getElementById('numbers');
  const previewExprEl = document.getElementById('preview-expression');
  const previewResultEl = document.getElementById('preview-result');
  const alertEl = document.getElementById('alert');
  const formEl = document.getElementById('edit-form');

  function getToken() {
    try {
      return localStorage.getItem('access_token'); // adjust if using a different key
    } catch { return null; }
  }
  function authHeaders() {
    const token = getToken();
    return token ? { 'Authorization': `Bearer ${token}` } : {};
  }
  function showAlert(kind, msg) {
    alertEl.className = `alert alert-${kind}`;
    alertEl.textContent = msg;
    alertEl.classList.remove('d-none');
  }

  function parseInputs(text) {
    return text
      .split(',')
      .map(s => s.trim())
      .filter(s => s.length > 0)
      .map(Number)
      .filter(n => !Number.isNaN(n));
  }

  function computePreview(type, inputs) {
    if (!Array.isArray(inputs) || inputs.length < 2) return { expr: '—', result: '—' };
    let result = inputs[0];
    let expr = String(inputs[0]);

    switch (type) {
      case 'addition':
        result = inputs.reduce((acc, v) => acc + v, 0);
        expr = inputs.join(' + ');
        break;
      case 'subtraction':
        for (let i = 1; i < inputs.length; i++) result -= inputs[i];
        expr = inputs.join(' - ');
        break;
      case 'multiplication':
        result = inputs.reduce((acc, v) => acc * v, 1);
        expr = inputs.join(' × ');
        break;
      case 'division':
        for (let i = 1; i < inputs.length; i++) {
          if (inputs[i] === 0) return { expr: expr + ' / 0', result: 'Error: Cannot divide by zero!' };
          result /= inputs[i];
          expr += ' / ' + inputs[i];
        }
        return { expr, result };
      default:
        return { expr: '—', result: '—' };
    }
    return { expr, result };
  }

  function updatePreview() {
    const type = operationEl.value;
    const inputs = parseInputs(numbersEl.value);
    const { expr, result } = computePreview(type, inputs);
    previewExprEl.textContent = expr;
    previewResultEl.textContent = result;
  }

  async function loadCalculation() {
    try {
      const res = await fetch(`/calculations/${calcId}`, {
        method: 'GET',
        cache: 'no-store',
        headers: { 'Accept': 'application/json', ...authHeaders() }
      });
      if (!res.ok) throw new Error(`Failed to load (status ${res.status})`);
      const calc = await res.json();
      currentTypeEl.textContent = calc.type;
      currentInputsEl.textContent = Array.isArray(calc.inputs) ? calc.inputs.join(', ') : '—';
      currentResultEl.textContent = (calc.result ?? '—');

      operationEl.value = calc.type;
      numbersEl.value = Array.isArray(calc.inputs) ? calc.inputs.join(', ') : '';
      updatePreview();
    } catch (err) {
      showAlert('danger', `Error loading calculation: ${err.message}`);
    }
  }

  formEl.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const type = operationEl.value;
    const inputs = parseInputs(numbersEl.value);

    if (inputs.length < 2) {
      showAlert('warning', 'Please enter at least two numbers.');
      return;
    }
    if (type === 'division' && inputs.slice(1).includes(0)) {
      showAlert('warning', 'Cannot divide by zero!');
      return;
    }

    try {
      const res = await fetch(`/calculations/${calcId}`, {
        method: 'PUT',
        cache: 'no-store',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          ...authHeaders()
        },
        body: JSON.stringify({ type, inputs })
      });
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || `Update failed (status ${res.status})`);
      }
      const updated = await res.json();
      showAlert('success', 'Calculation updated successfully.');

      currentTypeEl.textContent = updated.type;
      currentInputsEl.textContent = Array.isArray(updated.inputs) ? updated.inputs.join(', ') : '—';
      currentResultEl.textContent = (updated.result ?? '—');

      setTimeout(() => {
        window.location.href = `/dashboard?t=${Date.now()}`;
      }, 900);
    } catch (err) {
      showAlert('danger', `Error updating calculation: ${err.message}`);
    }
  });

  operationEl.addEventListener('change', updatePreview);
  numbersEl.addEventListener('input', updatePreview);

  if (calcId) loadCalculation();
})();
</script>
{% endblock %}

